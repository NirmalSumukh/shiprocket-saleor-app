# ============================================
# Saleor ShipRocket App - Traefik Integration
# ============================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saleor-shiprocket-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - APL=${APL:-file}
      - SECRET_KEY=${SECRET_KEY}
      - APP_IFRAME_BASE_URL=https://shiprocket.leemasmart.com
      - APP_API_BASE_URL=https://shiprocket.leemasmart.com
      - NEXT_PUBLIC_APP_URL=https://shiprocket.leemasmart.com
      - SALEOR_API_URL=${SALEOR_API_URL:-https://saleor.leemasmart.com/graphql/}
      - SALEOR_APP_TOKEN=${SALEOR_APP_TOKEN}
      - DEFAULT_CHANNEL=${DEFAULT_CHANNEL:-default-channel}
      - SHIPROCKET_API_KEY=${SHIPROCKET_API_KEY}
      - SHIPROCKET_SECRET_KEY=${SHIPROCKET_SECRET_KEY}
      - SHIPROCKET_API_BASE_URL=${SHIPROCKET_API_BASE_URL:-https://checkout-api.shiprocket.com}
      - DATABASE_URL=${DATABASE_URL:-}
      - STOREFRONT_URL=${STOREFRONT_URL:-https://leemasmart.com}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://leemasmart.com,https://saleor.leemasmart.com,https://shiprocket.leemasmart.com}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=leemasmart-network" # ADDED: Explicit network declaration
      - "traefik.http.routers.shiprocket.rule=Host(`shiprocket.leemasmart.com`)"
      - "traefik.http.routers.shiprocket.entrypoints=websecure"
      - "traefik.http.routers.shiprocket.tls.certresolver=letsencrypt"
      - "traefik.http.services.shiprocket.loadbalancer.server.port=3010"
      - "traefik.http.routers.shiprocket.middlewares=shiprocket-headers"
      - "traefik.http.middlewares.shiprocket-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.shiprocket-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.shiprocket-headers.headers.stsIncludeSubdomains=true"
    volumes:
      - shiprocket-data:/app/data
    networks:
      - leemasmart-network # FIXED: Removed prefix
    expose:
      - "3010"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3010/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ============================================
# Networks - FIXED: Use correct network name
# ============================================
networks:
  leemasmart-network:
    # FIXED: Removed prefix
    external: true

# ============================================
# Volumes
# ============================================
volumes:
  shiprocket-data:
    driver: local
