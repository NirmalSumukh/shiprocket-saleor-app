# ============================================
# Saleor ShipRocket App - Standalone Deployment
# ============================================
#
# PREREQUISITES:
#   1. Global Traefik must be running (creates proxy-network)
#   2. Saleor backend must be running on proxy-network
#
# Usage:
#   docker compose up -d --build
#
# ============================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saleor-shiprocket-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - APL=${APL:-file}
      - SECRET_KEY=${SECRET_KEY}
      - APP_IFRAME_BASE_URL=https://shiprocket.leemasmart.com
      - APP_API_BASE_URL=https://shiprocket.leemasmart.com
      - NEXT_PUBLIC_APP_URL=https://shiprocket.leemasmart.com
      # Use external URL for Saleor API (not internal Docker hostname)
      - SALEOR_API_URL=${SALEOR_API_URL:-https://saleor.leemasmart.com/graphql/}
      - SALEOR_APP_TOKEN=${SALEOR_APP_TOKEN}
      - DEFAULT_CHANNEL=${DEFAULT_CHANNEL:-default-channel}
      - SHIPROCKET_API_KEY=${SHIPROCKET_API_KEY}
      - SHIPROCKET_SECRET_KEY=${SHIPROCKET_SECRET_KEY}
      - SHIPROCKET_API_BASE_URL=${SHIPROCKET_API_BASE_URL:-https://checkout-api.shiprocket.com}
      - DATABASE_URL=${DATABASE_URL:-}
      - STOREFRONT_URL=${STOREFRONT_URL:-https://leemasmart.com}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://leemasmart.com,https://saleor.leemasmart.com,https://shiprocket.leemasmart.com}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy-network"
      - "traefik.http.routers.shiprocket.rule=Host(`shiprocket.leemasmart.com`)"
      - "traefik.http.routers.shiprocket.entrypoints=websecure"
      - "traefik.http.routers.shiprocket.tls.certresolver=letsencrypt"
      - "traefik.http.services.shiprocket.loadbalancer.server.port=3010"
      # Traefik health check
      - "traefik.http.services.shiprocket.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.shiprocket.loadbalancer.healthcheck.interval=10s"
    volumes:
      - shiprocket-data:/app/data
    networks:
      - proxy-network
    expose:
      - "3010"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://127.0.0.1:3010/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  proxy-network:
    external: true

volumes:
  shiprocket-data:
    driver: local
